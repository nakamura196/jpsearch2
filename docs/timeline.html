<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>

<body>
  <div id="my-timeline" class="py-5"></div>

  <p id="loading" class="text-center">
    <img src="assets/loading.gif" /><br />
    <span>Loading timeline ...</span>
  </p>

  <p id="result" class="text-center container"></p>

  <script src="https://code.jquery.com/jquery-3.3.1.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>

  <script type="text/javascript" src="assets/thirdparty/TimelineJS/js/storyjs-embed.js"></script>

  <script type="text/javascript" src="assets/thirdparty/TimelineJS/js/site.js"></script>

  <script>

    var arg = getParam()
    var term = arg["q"] != null ? arg["q"] : "葛飾北斎";

    let query = "";

    query += " PREFIX schema: <http://schema.org/> \n";
    query += " PREFIX chname: <https://jpsearch.go.jp/entity/chname/> \n";
    query += " PREFIX jps: <https://jpsearch.go.jp/term/property#> \n";
    query += " select distinct ?plabel ?pthumbnail ?bd ?dd ?pcomment ?e where { \n";

    query += "  SERVICE <https://jpsearch.go.jp/rdf/sparql> {\n";
    query += "    ?s jps:agential [ jps:relationType/skos:broader?/rdfs:label '制作'; jps:value ?x ] . \n";
    query += "    ?x rdfs:label ?xlabel . filter(?xlabel = '" + term + "')\n";
    query += "    ?s jps:agential [jps:relationType/skos:broader?/rdfs:label '制作'; jps:value ?dest ] . \n";
    query += "    ?dest rdfs:label ?plabel.filter(?plabel != '" + term + "')\n";
    query += "    ?dest schema:image ?pthumbnail.\n";
    query += "    FILTER(strstarts(str(?dest), \"https://jpsearch.go.jp/entity/\"))\n";
    query += "    ?dest owl:sameAs? ?e.\n";
    query += "    FILTER(strstarts(str(?e), \"http://www.wikidata.org/\"))\n";
    query += "  }\n";
    query += "  SERVICE <https://query.wikidata.org/sparql> { \n";
    query += "    ?e <http://www.wikidata.org/prop/direct/P569> ?bd;  \n";
    query += "      <http://www.wikidata.org/prop/direct/P570> ?dd;\n";
    query += "      schema:description ?pcomment.\n";
    query += "    filter(lang(?pcomment) = \"ja\")\n";
    query += "  } \n";
    query += " } \n";

    console.log(query)

    $.ajax({
      url: 'https://sparql.dl.itc.u-tokyo.ac.jp',
      type: 'POST',
      data: {
        query: query,
        format: "json"
      }
    })
      // Ajaxリクエストが成功した時発動
      .done((data) => {

        var result = data.results.bindings;

        var dataObject = arrangeJson4Timeline2(result);

        //空じゃなければ
        if (dataObject.timeline.date.length != 0) {
          createStoryJS({
            type: 'timeline',
            width: '100%',
            height: '600',
            source: dataObject,
            embed_id: 'my-timeline',
            lang: 'ja'
          });
        }
      })
      // Ajaxリクエストが失敗した時発動
      .fail((data) => {
        //alert(data.statusText);
        console.log(data.statusText)
        $("#result").append('<div class="alert alert-warning" role="alert">Sorry, something went wrong.</div>')
      })
      // Ajaxリクエストが成功・失敗どちらでも発動
      .always((data) => {
        $("#loading").empty()
      });

    function arrangeJson4Timeline2(data) {

      var result = new Object();

      var timeline = new Object();
      result["timeline"] = timeline;

      timeline["headline"] = "";
      timeline["type"] = "default";
      timeline["text"] = "";

      var array = new Array();
      timeline["date"] = array;

      for (var i = 0; i < data.length; i++) {

        var obj = data[i];

        var title = obj.plabel.value

        var bd = obj.bd.value.split("T")[0];
        var dd = obj.dd.value.split("T")[0];

        //--------------------------------

        var event = new Object();//一要素
        array.push(event);

        //--------------------------------

        event["startDate"] = bd.replace(/-/g, ",");
        event["endDate"] = dd.replace(/-/g, ",");

        //---------------------------------

        event["headline"] = title;

        //----------------------------------

        //表示情報
        var div = $("<div>");

        var p = $("<p>");
        div.append(p);
        p.append(obj.pcomment.value)

        //----------------------------------

        var thumb = obj.pthumbnail;
        if (thumb != null) {

          //ASSET

          var thumb = thumb.value;

          var asset = new Object();


          asset.media = thumb;
          asset.thumbnail = thumb;

          event["asset"] = asset;

        }

        var a = $("<a>");
        div.append(a)
        var url = "./#/search?q=" + title

        a.append('View &raquo;')
        a.attr("href", url)
        a.attr("target", "_parent");

        //----------------------------------

        var spanStr = $('<div>').append(div.clone()).html();
        event["text"] = spanStr;

      }

      return result;
    }

    function getParam() {
      var arg = new Object;
      url = location.search.substring(1).split('&');

      for (i = 0; url[i]; i++) {
        var k = url[i].split('=');
        arg[k[0]] = decodeURIComponent(k[1]);
      }

      return arg
    }
  </script>
</body>

</html>