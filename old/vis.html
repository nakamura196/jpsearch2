<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>電子展示プロトタイプ</title>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" type="text/css" />
  <link href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css" rel="stylesheet">
  <!-- Bootstrap core CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet">
  <!-- Material Design Bootstrap -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.5.4/css/mdb.min.css" rel="stylesheet">


  <style type="text/css">
    #mynetwork {
      width: 100%;
      height: 900px;
      border: 1px solid lightgray;
      background-color: #333333;
    }
  </style>
</head>

<body>

  <!--Main Navigation-->
  <header>

    <!--Navbar-->
    <nav class="navbar navbar-expand-lg navbar-light white scrolling-navbar">
      <a class="navbar-brand" href="./">電子展示プロトタイプ</a>
    </nav>
    <!--/.Navbar-->

  </header>
  <!--Main Navigation-->

  <!--Main layout-->
  <main class="mb-5">
    <div class="container-fluid mt-5">

      <div id="mynetwork"></div>

    </div>
  </main>
  <!--Main layout-->

  <!--Footer-->
  <footer class="page-footer text-center font-small mdb-color darken-2 mt-4 fadeIn">

    <!--Copyright-->
    <div class="footer-copyright py-5">
      Satoru Nakamura
    </div>
    <!--/.Copyright-->

  </footer>
  <!--/.Footer-->

  <script type="text/javascript" language="javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>


  <script type="text/javascript">

    var arg = new Object;
    url = location.search.substring(1).split('&');

    for (i = 0; url[i]; i++) {
      var k = url[i].split('=');
      arg[k[0]] = decodeURIComponent(k[1]);
    }

    var resourceUri = arg["resourceUri"] ? arg["resourceUri"] : "https://jpsearch.go.jp/entity/chname/葛飾北斎"

    var nodes, edges, network;

    init()
    add(resourceUri)

    function add_data(uri) {

      var query = " select distinct ?s ?label ?thumbnail where { \n";

      query += "	?s jps:agential\n";
      query += "		[jps:relationType/skos:broader?/rdfs:label \"制作\"; jps:value/owl:sameAs? <" + uri + "> ],\n";
      query += "		[jps:relationType/skos:broader?/rdfs:label \"制作\"; jps:value ?dest ]\n";
      query += "	FILTER(?dest != <" + uri + "> )\n";
      query += "	FILTER(strstarts(str(?dest), \"https://jpsearch.go.jp/entity/chname/\"))\n";
      query += "  ?dest schema:image ?pthumbnail; \n";
      query += "      rdfs:label ?plabel . \n";
      query += "  ?s rdfs:label ?label; \n";
      query += "      schema:image ?thumbnail . \n";
      query += "} LIMIT 30 \n";

      $.ajax({
        url: "https://jpsearch.go.jp/rdf/sparql/",
        type: 'POST',
        data: {
          query: query,
          format: "json"
        }
      })
        // Ajaxリクエストが成功した時発動
        .done((data) => {
          var result = data.results.bindings;
          for (var i = 0; i < result.length; i++) {

            var obj = result[i]
            var link = obj.s.value;

            if (i == 0) {
              //target node
              var othumb = null
              if (obj.thumbnail) {
                othumb = obj.thumbnail.value;
              }
              addNode(uri, othumb, uri);
            }

            var img_url = null
            if (obj["thumbnail"]) {
              img_url = obj["thumbnail"].value
            }

            addNode(link, img_url, obj.label.value)
            addEdge(uri, link, 1)

          }
        })
        // Ajaxリクエストが失敗した時発動
        .fail((data) => {
          alert(data.statusText);
        })
        // Ajaxリクエストが成功・失敗どちらでも発動
        .always((data) => {
          $("#loading").empty()
        });

    }

    function add_entity(uri) {

      var query = " select distinct ?dest ?plabel ?pthumbnail where { \n";

      query += "	?s jps:agential\n";
      query += "		[jps:relationType/skos:broader?/rdfs:label \"制作\"; jps:value ?dest ]\n";
      query += "	FILTER(?s = <" + uri + "> )\n";
      query += "	FILTER(strstarts(str(?dest), \"https://jpsearch.go.jp/entity/chname/\"))\n";
      query += "  ?dest schema:image ?pthumbnail; \n";
      query += "      rdfs:label ?plabel . \n";
      query += "  ?s rdfs:label ?label; \n";
      query += "      schema:image ?thumbnail . \n";
      query += "} LIMIT 30 \n";

      $.ajax({
        url: "https://jpsearch.go.jp/rdf/sparql/",
        type: 'POST',
        data: {
          query: query,
          format: "json"
        }
      })
        // Ajaxリクエストが成功した時発動
        .done((data) => {
          var result = data.results.bindings;

          for (var i = 0; i < result.length; i++) {

            var obj = result[i]
            var link = obj.dest.value;

            var img_url = null
            if (obj["pthumbnail"]) {
              img_url = obj["pthumbnail"].value
            }

            addNode(link, img_url, obj.plabel.value)
            addEdge(link, uri, 1)

          }
        })
        // Ajaxリクエストが失敗した時発動
        .fail((data) => {
          alert(data.statusText);
        })
        // Ajaxリクエストが成功・失敗どちらでも発動
        .always((data) => {
          $("#loading").empty()
        });
    }

    function add(uri) {

      if (uri.indexOf("/entity/") != -1) {
        add_data(uri)
      } else {
        add_entity(uri)
      }

    }

    function init() {

      nodes = new vis.DataSet([]);
      edges = new vis.DataSet([]);

      var query = " select distinct ?dest ?plabel ?pthumbnail where { \n";

      query += " <" + resourceUri + "> schema:image ?pthumbnail; \n";
      query += "      rdfs:label ?plabel . \n";
      query += "} LIMIT 1 \n";

      $.ajax({
        url: "https://jpsearch.go.jp/rdf/sparql/",
        type: 'POST',
        data: {
          query: query,
          format: "json"
        }
      })
        // Ajaxリクエストが成功した時発動
        .done((data) => {
          var result = data.results.bindings;
          for (var i = 0; i < result.length; i++) {

            var obj = result[i]

            var othumb = null
            if (obj.pthumbnail) {
              othumb = obj.pthumbnail.value;
            }
            addNode(resourceUri, othumb, obj.plabel.value);

          }
        })
        // Ajaxリクエストが失敗した時発動
        .fail((data) => {
          alert(data.statusText);
        })
        // Ajaxリクエストが成功・失敗どちらでも発動
        .always((data) => {
          $("#loading").empty()
        });


      // create a network
      var container = document.getElementById('mynetwork');
      var data = {
        nodes: nodes,
        edges: edges
      };
      var options = {
        nodes: {
          //borderWidth:4,
          //size:30,
          color: {
            //border: '#222222',
            border: 'white',
            background: '#666666'
          },
          font: { color: '#eeeeee' }
        },
        edges: {}
      };
      network = new vis.Network(container, data, options);

      network.on("click", function (params) {
        params.event = "[original event]";
        //document.getElementById('eventSpan').innerHTML = '<h2>Click event:</h2>' + JSON.stringify(params, null, 4);
        node = this.getNodeAt(params.pointer.DOM);
        if (node != null) {
          //addNewNode(node)
          add(node)
        }
      });

    }

    function addNode(node_id, img_url, label) {
      try {
        if (img_url != null) {
          nodes.add({
            id: node_id,
            label: label,
            image: img_url,
            shape: "image"
          });
        } else {
          nodes.add({
            id: node_id,
            label: label
          });
        }

      }
      catch (err) {
        console.log(err);
      }
    }

    function addEdge(from, to, value) {
      try {
        edges.add({
          id: from + "_" + to,
          from: from,
          to: to,
          arrows: "to"
        });
      }
      catch (err) {
        console.log(err);
      }
    }

  </script>
</body>

</html>