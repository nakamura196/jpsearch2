<!DOCTYPE html>
<html lang="ja">

<head>
</head>

<body>
  <div id="my-timeline" class="py-5"></div>

  <script src="https://code.jquery.com/jquery-3.3.1.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>

  <script type="text/javascript" src="assets/thirdparty/TimelineJS/js/storyjs-embed.js"></script>

  <script type="text/javascript" src="assets/thirdparty/TimelineJS/js/site.js"></script>

  <script>

    var arg = getParam()
    var term = arg["q"] != null ? arg["q"] : "";

    let query = "";

    query += "select distinct ?plabel ?pthumbnail ?bd ?dd ?pcomment ?e where { \n";
    query += "    <http://ja.dbpedia.org/resource/" + term + "> <http://dbpedia.org/ontology/wikiPageWikiLink> ?o .   \n";
    query += "?o rdfs:label ?plabel.  \n";
    query += "?o rdfs:comment ?pcomment.  \n";
    query += "?o <http://dbpedia.org/ontology/thumbnail> ?pthumbnail.  \n";

    query += "?o <http://www.w3.org/2002/07/owl#sameAs> ?e \n";
    query += "           FILTER(strstarts(str(?e), \"http://www.wikidata.org/\")) \n";
    //query += "   ?o rdf:type <http://schema.org/Person> .  \n";

    query += "   SERVICE <https://query.wikidata.org/sparql> { \n";
    query += "  ?e <http://www.wikidata.org/prop/direct/P569> ?bd;  \n";
    query += "  <http://www.wikidata.org/prop/direct/P570> ?dd. \n";
    query += " } \n";

    query += "   SERVICE <https://jpsearch.go.jp/rdf/sparql> { \n";
    query += "  ?cho rdfs:label ?label; \n";
    query += "   owl:sameAs? ?e.  \n";
    //query += "   ?e rdf:type <https://jpsearch.go.jp/term/type/Agent> .  \n";
    query += "   ?cho schema:image ?thumbnail \n";
    query += " } \n";
    query += "} "//LIMIT 12 \n";

    console.log(query)

    $.ajax({
      url: 'http://ja.dbpedia.org/sparql?query=',
      type: 'POST',
      data: {
        query: query,
        format: "json"
      }
    })
      // Ajaxリクエストが成功した時発動
      .done((data) => {

        var result = data.results.bindings;

        var dataObject = arrangeJson4Timeline2(result);

        //空じゃなければ
        if (dataObject.timeline.date.length != 0) {
          createStoryJS({
            type: 'timeline',
            width: '100%',
            height: '600',
            source: dataObject,
            embed_id: 'my-timeline',
            lang: 'ja'
          });
        }
      })
      // Ajaxリクエストが失敗した時発動
      .fail((data) => {
        //alert(data.statusText);
        console.log(data.statusText)
      })
      // Ajaxリクエストが成功・失敗どちらでも発動
      .always((data) => {
        $("#loading").empty()
      });

    function arrangeJson4Timeline2(data) {

      var result = new Object();

      var timeline = new Object();
      result["timeline"] = timeline;

      timeline["headline"] = "";
      timeline["type"] = "default";
      timeline["text"] = "";

      var array = new Array();
      timeline["date"] = array;

      for (var i = 0; i < data.length; i++) {

        var obj = data[i];

        var title = obj.plabel.value

        var bd = obj.bd.value.split("T")[0];
        var dd = obj.dd.value.split("T")[0];

        //--------------------------------

        var event = new Object();//一要素
        array.push(event);

        //--------------------------------

        event["startDate"] = bd.replace(/-/g, ",");
        event["endDate"] = dd.replace(/-/g, ",");

        //---------------------------------

        event["headline"] = title;

        //----------------------------------

        //表示情報
        var div = $("<div>");

        var p = $("<p>");
        div.append(p);
        p.append(obj.pcomment.value)

        //----------------------------------

        var thumb = obj.pthumbnail;
        if (thumb != null) {

          //ASSET

          var thumb = thumb.value;

          var asset = new Object();


          asset.media = thumb;
          asset.thumbnail = thumb;

          event["asset"] = asset;

        }

        var a = $("<a>");
        div.append(a)
        var url = "./#/search?q=" + title

        a.append('View &raquo;')
        a.attr("href", url)
        a.attr("target", "_parent");

        //----------------------------------

        var spanStr = $('<div>').append(div.clone()).html();
        event["text"] = spanStr;

      }

      return result;
    }

    function getParam() {
      var arg = new Object;
      url = location.search.substring(1).split('&');

      for (i = 0; url[i]; i++) {
        var k = url[i].split('=');
        arg[k[0]] = decodeURIComponent(k[1]);
      }

      return arg
    }
  </script>
</body>

</html>